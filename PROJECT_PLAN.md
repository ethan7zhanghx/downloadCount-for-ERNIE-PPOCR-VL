# ERNIE 模型数据大屏项目规划书

> **版本**: v1.0
> **日期**: 2025-01-27
> **目标**: 3天内完成可部署的数据大屏系统

---

## 一、项目背景与诉求

### 1.1 现状

| 维度 | 现状描述 |
|------|----------|
| **数据采集** | 已有 fetcher 程序，支持 7 个平台的数据采集 |
| **数据存储** | SQLite 数据库，约 1.3 万条记录 |
| **分析能力** | 有基础的分析模块，但缺乏系统化指标体系 |
| **展示方式** | Streamlit 原型界面，未面向管理层优化 |
| **更新频率** | 目前一周一次手动运行（需切换VPN） |
| **数据质量** | 历史数据有缺失，近期数据质量较好 |

### 1.2 核心诉求

```
┌─────────────────────────────────────────────────────────────┐
│  业务诉求                                                    │
│  ├─ 构建可随时查看的数据大屏                                  │
│  ├─ 支持管理层了解 ERNIE 模型生态的关键趋势                  │
│  └─ 团队内部用于跟踪各平台数据表现                            │
├─────────────────────────────────────────────────────────────┤
│  技术诉求                                                    │
│  ├─ 解决跨境访问的 VPN 切换问题（国内/国外数据源）            │
│  ├─ 建立数据质量体系，避免缺失/错误数据误导决策              │
│  ├─ 建立指标口径版本管理，适应未来范围定义变化               │
│  └─ 轻量级架构，低成本运维                                   │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 约束条件

| 约束 | 具体要求 |
|------|----------|
| **时间** | 3天内完成上线 |
| **预算** | 尽量低成本 |
| **更新频率** | 日更即可 |
| **受众** | 包含管理层，需要正式的KPI展示 |
| **团队能力** | 非专业数分团队，需轻量级方案 |

---

## 二、初步设想（技术方案）

### 2.1 总体架构

```
                    ┌─────────────────────────────────────┐
                    │         数据大屏 (Streamlit)          │
                    │   - 核心指标卡片                      │
                    │   - 趋势分析图表                      │
                    │   - 数据质量监控                      │
                    └─────────────────┬───────────────────┘
                                      │ 只读查询
                                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                      指标层 (Mart Layer)                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ metrics_daily   │  │ metrics_weekly  │  │ metric_versions │ │
│  │ - 平台维度      │  │ - 周汇总        │  │ - 口径变更记录  │ │
│  │ - 模型分类维度  │  │ - 同比/环比     │  │                 │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                   数据仓库层 (DW Layer)                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ model_downloads │  │ data_quality    │  │ ingestion_log   │ │
│  │ (原始表+扩展)   │  │ - 每日质量统计  │  │ - 采集流水      │ │
│  │                 │  │ - 新鲜度        │  │ - 批次追踪      │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                      │
                    ┌─────────────────┴─────────────────┐
                    ▼                                   ▼
┌───────────────────────────┐         ┌───────────────────────────┐
│   国内采集节点 (CN)        │         │  国外采集节点 (Global)     │
│  - AI Studio               │         │  - Hugging Face           │
│  - Gitee                   │         │  - ModelScope             │
│  - Modelers                │         │  - GitCode                │
│  - CAICT                   │         │                            │
└───────────────────────────┘         └───────────────────────────┘
         │                                           │
         └───────────────┬───────────────────────────┘
                         ▼
                  ┌─────────────┐
                  │ 共享数据库   │
                  │ (MySQL/PG)  │
                  └─────────────┘
```

### 2.2 采集方案：双节点架构

| 节点 | 部署位置 | 负责平台 | 访问要求 |
|------|----------|----------|----------|
| **国内节点** | 国内云服务器（如阿里云） | AI Studio、Gitee、Modelers、CAICT | 需国内网络 |
| **国外节点** | 国外云服务器（如 AWS/Lightsail） | HuggingFace、ModelScope、GitCode | 需国外网络 |

**优势**：
- 无需VPN切换，各节点访问可达数据源
- 采集互不干扰，单点故障不影响整体
- 可独立扩展和维护

**数据汇聚**：
- 两个节点写入同一个共享数据库
- 通过 `ingestion_log` 表记录每次采集的批次信息
- 支持追溯每条数据的来源和采集时间

### 2.3 数据层设计

#### 2.3.1 元数据扩展（对现有表的改造）

```sql
-- 在 model_downloads 表上新增字段
ALTER TABLE model_downloads ADD COLUMN:
  - batch_id TEXT           -- 采集批次ID（YYYYMMDD_HHMMSS_节点名）
  - snapshot_date DATE      -- 数据快照日期（业务日期）
  - source_record_id TEXT   -- 源系统唯一标识（平台+模型ID）
  - ingestion_time DATETIME -- 入库时间
  - is_deleted INTEGER      -- 软删除标记（0=正常，1=已删除）
  - quality_score INTEGER   -- 数据质量分数（0-100）
```

#### 2.3.2 新增质量表

```sql
CREATE TABLE data_quality_daily (
    date DATE PRIMARY KEY,
    source TEXT NOT NULL,              -- 数据源/平台
    total_records INTEGER,             -- 总记录数
    new_records INTEGER,               -- 新增记录数
    updated_records INTEGER,           -- 更新记录数
    deleted_records INTEGER,           -- 删除记录数
    null_rate REAL,                    -- 关键字段缺失率
    duplicate_rate REAL,               -- 重复率
    last_success_time DATETIME,        -- 最后成功采集时间
    failure_count INTEGER,             -- 失败次数
    quality_score INTEGER,             -- 质量分数
    notes TEXT                         -- 备注
);
```

#### 2.3.3 新增采集日志表

```sql
CREATE TABLE ingestion_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    batch_id TEXT UNIQUE NOT NULL,     -- 批次ID
    node TEXT NOT NULL,                -- 节点标识（cn/global）
    sources TEXT NOT NULL,             -- 采集的数据源（JSON数组）
    start_time DATETIME,               -- 开始时间
    end_time DATETIME,                 -- 结束时间
    status TEXT NOT NULL,              -- 状态（success/failed/partial）
    records_inserted INTEGER,          -- 插入记录数
    records_updated INTEGER,           -- 更新记录数
    records_failed INTEGER,            -- 失败记录数
    error_message TEXT,                -- 错误信息
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.3.4 指标层表

```sql
-- 日指标表
CREATE TABLE metrics_daily (
    date DATE NOT NULL,
    platform TEXT NOT NULL,
    model_category TEXT NOT NULL,      -- ernie-4.5 / paddleocr-vl / other
    total_downloads BIGINT,            -- 总下载量
    active_models INTEGER,             -- 活跃模型数
    new_models INTEGER,                -- 新增模型数
    official_models INTEGER,           -- 官方模型数
    derivative_models INTEGER,         -- 衍生模型数
    avg_downloads_per_model REAL,      -- 平均下载量
    max_downloads BIGINT,              -- 最高下载量
    downloads_growth_rate REAL,        -- 增长率（vs 前一天）
    metric_version TEXT,               -- 指标口径版本
    PRIMARY KEY (date, platform, model_category)
);

-- 周指标表
CREATE TABLE metrics_weekly (
    week_date DATE NOT NULL,           -- 周一日期
    platform TEXT NOT NULL,
    model_category TEXT NOT NULL,
    week_total_downloads BIGINT,
    week_new_models INTEGER,
    week_growth_rate REAL,             -- 周环比
    week_over_week_growth REAL,        -- 同周增长率
    metric_version TEXT,
    PRIMARY KEY (week_date, platform, model_category)
);

-- 指标口径版本表
CREATE TABLE metric_versions (
    version_id TEXT PRIMARY KEY,       -- v1.0, v1.1 等
    effective_date DATE,               -- 生效日期
    description TEXT,                  -- 变更说明
    changes TEXT,                      -- 具体变更内容（JSON）
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2.4 大屏设计

#### 2.4.1 页面布局

```
┌────────────────────────────────────────────────────────────────┐
│  🔍 ERNIE 模型生态数据看板                           [更新时间] │
├────────────────────────────────────────────────────────────────┤
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐          │
│  │总下载量  │ │活跃模型  │ │本周新增  │ │数据质量  │          │
│  │  12.5M   │ │   1,856  │ │    +42   │ │  ✓ 98%   │          │
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘          │
├────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────┐ ┌───────────────────────────┐ │
│  │      下载量趋势（近30天）     │ │      平台分布对比         │ │
│  │     [折线图 + 多平台]        │ │      [饼图/柱状图]        │ │
│  └─────────────────────────────┘ └───────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────┐ ┌───────────────────────────┐ │
│  │      Top 10 热门模型         │ │    官方 vs 衍生生态       │ │
│  │      [排行榜 + 趋势mini图]   │ │      [堆叠面积图]         │ │
│  └─────────────────────────────┘ └───────────────────────────┘ │
├────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    数据质量监控面板                       │  │
│  │  各平台采集状态 | 数据新鲜度 | 质量分数 | 异常告警        │  │
│  └─────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
```

#### 2.4.2 核心指标定义

| 指标名称 | 定义 | 计算逻辑 |
|----------|------|----------|
| **总下载量** | 所有平台累计下载量 | SUM(download_count) |
| **活跃模型数** | 近7天有下载的模型数 | COUNT(DISTINCT model_name) WHERE date >= 最近7天 |
| **本周新增模型** | 本周新出现的模型数 | COUNT(DISTINCT 新模型) WHERE 首次出现在本周 |
| **官方/衍生比例** | 官方模型与衍生模型的比值 | 官方模型数 / 衍生模型数 |
| **数据质量分数** | 数据完整性评分 | (1 - 缺失率) × 100 |
| **下载增长率** | 日/周环比增长 | (本期 - 上期) / 上期 × 100% |

---

## 三、排期规划（3天）

### Day 1：数据层改造（优先级：P0）

| 任务 | 预估工时 | 交付物 |
|------|----------|--------|
| **数据库schema设计** | 1h | 完整的DDL脚本 |
| **元数据字段扩展** | 2h | 表结构修改 + 历史数据回刷脚本 |
| **质量表实现** | 1h | `data_quality_daily` 表 + 填充逻辑 |
| **指标表实现** | 3h | `metrics_daily`/`metrics_weekly` 表 + 计算脚本 |
| **采集日志表** | 1h | `ingestion_log` 表 + 记录逻辑 |

**Day 1 结束标准**：
- 所有新表创建完成
- 历史数据回刷完成
- 指标计算脚本可产出正确数据

### Day 2：采集架构改造（优先级：P0）

| 任务 | 预估工时 | 交付物 |
|------|----------|--------|
| **配置文件拆分** | 1.5h | `config_cn.py` + `config_global.py` |
| **采集脚本改造** | 2h | 支持批次ID、采集日志记录 |
| **部署脚本编写** | 1.5h | 一键安装 + 定时任务配置 |
| **数据库选型验证** | 1h | SQLite 或 MySQL 的最终确定 |
| **双节点联调** | 2h | 本地模拟双节点采集，验证数据正确性 |

**Day 2 结束标准**：
- 国内/国外节点配置分离完成
- 采集脚本支持批次追踪
- 双节点可同时写入数据库不冲突

### Day 3：大屏开发（优先级：P0-P1）

| 任务 | 预估工时 | 交付物 |
|------|----------|--------|
| **核心指标卡片** | 1.5h | 4-5个KPI卡片，带趋势箭头 |
| **趋势图表** | 2h | 下载量折线图（多平台对比） |
| **平台分布图** | 1h | 饼图/柱状图 |
| **Top模型榜** | 1.5h | 可交互的排行榜 |
| **官方vs衍生图** | 1h | 堆叠图或分组对比 |
| **质量监控面板** | 1h | 各平台状态、质量分数展示 |

**Day 3 结束标准**：
- 大屏可正常访问
- 所有图表数据正确
- 页面美观、面向管理层友好

### 后续优化（P2，不阻塞上线）

| 优化项 | 优先级 | 预估工时 |
|--------|--------|----------|
| 删除语义完整实现（as-of 查询） | P2 | 1-2天 |
| 完整的告警系统 | P2 | 1天 |
| 数据血缘和可视化 | P2 | 2天 |
| 性能优化（缓存、索引） | P2 | 1天 |
| 用户权限管理 | P2 | 1-2天 |

---

## 四、技术选型建议

### 4.1 云服务器选型（低成本方案）

| 用途 | 推荐配置 | 预估费用 |
|------|----------|----------|
| **国内节点** | 阿里云/腾讯云 1核2G | ¥30-50/月 |
| **国外节点** | AWS Lightsail/DigitalOcean 1核1G | $5-7/月 |
| **数据库** | 方案A：独立云数据库 MySQL | ¥50-100/月 |
|  | 方案B：使用其中一台节点托管 | ¥0 |
| **合计** | - | 约 ¥100-200/月 |

### 4.2 数据库选型

| 方案 | 优势 | 劣势 | 建议 |
|------|------|------|------|
| **SQLite + 网络文件系统** | 零成本、简单 | 并发能力弱、有锁风险 | 适合初期 |
| **MySQL（云数据库）** | 稳定、支持并发 | 有成本 | 长期推荐 |
| **PostgreSQL** | 功能强大 | 成本稍高 | 有复杂计算需求时 |

**建议**：初期用 SQLite + 单节点托管数据库，验证稳定后再迁移。

### 4.3 大屏技术栈

- **框架**：Streamlit（已有基础，快速迭代）
- **图表**：Plotly / Altair（交互性更好）
- **部署**：Streamlit Cloud 或 自建 + Nginx

---

## 五、风险与应对

| 风险 | 影响 | 概率 | 应对措施 |
|------|------|------|----------|
| 3天时间紧张，可能延期 | 高 | 中 | 按P0/P1分级，P2功能后置 |
| 双节点写数据库冲突 | 中 | 低 | 使用批次ID + 唯一约束 |
| 历史数据质量差影响指标 | 中 | 高 | 质量面板展示数据可信度 |
| 云服务器网络问题 | 高 | 中 | 健康检查 + 失败告警 |
| 管理层需求变更 | 中 | 中 | 先确认核心指标，后续可扩展 |

---

## 六、成功标准

### 最小可行产品（MVP）标准

- [ ] 双节点可独立完成各自平台的采集
- [ ] 数据库包含完整的元数据和质量信息
- [ ] 指标层可产出正确的日/周指标
- [ ] 大屏展示核心KPI和主要图表
- [ ] 数据质量监控可见
- [ ] 采集失败有日志可追溯

### 交付物清单

1. **代码类**
   - [ ] 改造后的 fetcher 代码
   - [ ] 数据库迁移脚本
   - [ ] 指标计算脚本
   - [ ] 大屏 Streamlit 应用

2. **配置类**
   - [ ] 国内/国外节点配置文件
   - [ ] 部署脚本
   - [ ] 定时任务配置

3. **文档类**
   - [ ] 部署手册
   - [ ] 指标口径说明
   - [ ] 故障排查手册

---

## 七、实施检查清单（给执行AI的提示）

当执行此规划时，请按以下顺序进行：

### Phase 1：数据层（Day 1）

```bash
# 1. 创建数据库迁移脚本
# 文件：scripts/migration_add_metadata_fields.sql
# 文件：scripts/migration_create_quality_tables.sql

# 2. 编写历史数据回刷脚本
# 文件：scripts/backfill_metadata.py

# 3. 创建指标计算脚本
# 文件：scripts/calculate_metrics.py

# 4. 验证数据正确性
# 运行测试脚本，确保回刷后数据完整
```

### Phase 2：采集层（Day 2）

```bash
# 1. 拆分配置文件
# 文件：ernie_tracker/config_cn.py
# 文件：ernie_tracker/config_global.py

# 2. 改造 base_fetcher，增加批次追踪
# 修改：ernie_tracker/fetchers/base_fetcher.py

# 3. 创建部署脚本
# 文件：deploy/deploy_cn.sh
# 文件：deploy/deploy_global.sh
# 文件：deploy/install_dependencies.sh

# 4. 本地模拟双节点测试
# 文件：tests/test_dual_node.py
```

### Phase 3：大屏层（Day 3）

```bash
# 1. 创建新的大屏页面
# 文件：pages/dashboard.py

# 2. 实现各组件
# - 指标卡片：components/kpi_cards.py
# - 趋势图：components/trend_charts.py
# - 质量面板：components/quality_panel.py

# 3. 样式优化
# - 添加CSS样式
# - 确保面向管理层友好的视觉设计
```

---

## 八、附录

### A. 平台分类（国内/国外）

| 国内节点 | 国外节点 |
|----------|----------|
| AI Studio | HuggingFace |
| Gitee | ModelScope |
| Modelers | GitCode |
| CAICT | |

### B. 核心指标口径说明

| 指标 | 口径 | 版本 |
|------|------|------|
| 活跃模型数 | 近7天有下载记录的模型 | v1.0 |
| 官方模型 | publisher 包含"百度"/"baidu"/"Paddle" | v1.0 |
| 衍生模型 | 非官方模型 | v1.0 |
| 总下载量 | 所有平台所有模型的下载量总和 | v1.0 |

### C. 关键代码位置

| 模块 | 文件路径 | 说明 |
|------|----------|------|
| 数据库初始化 | `ernie_tracker/db.py` | 表结构定义 |
| 采集器入口 | `ernie_tracker/fetchers/fetchers_unified.py` | 统一采集入口 |
| 分析模块 | `ernie_tracker/analysis.py` | 指标计算逻辑 |
| 主应用 | `app.py` | Streamlit 应用入口 |

---

> **文档维护**：本文档随项目进展更新，记录重要决策和变更。
